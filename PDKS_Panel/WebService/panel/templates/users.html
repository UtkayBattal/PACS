{% extends 'layout.html' %} {% block title %}Kullanıcı Yönetimi{% endblock %} {%
block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">Kullanıcı Yönetimi</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <a href="{{ url_for('add_user') }}" class="btn btn-sm btn-success">
      <i class="fas fa-plus"></i> Yeni Personel
    </a>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Kullanıcı Arama</h5>
  </div>
  <div class="card-body">
    <form action="{{ url_for('search_users') }}" method="GET" class="row g-3">
      <div class="col-12 col-md-8">
        <input
          type="text"
          name="q"
          class="form-control"
          placeholder="İsim, ID veya kart numarası ile ara..."
          value="{{ search_term if search_term else search if search else '' }}"
        />
      </div>
      <div class="col-12 col-md-4">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> Ara
        </button>
      </div>
    </form>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>Personel ID</th>
        <th>Ad Soyad</th>
        <th>Kart No</th>
        <th>Cinsiyet</th>
        <th>Meslek</th>
        <th>İş Tanımı</th>
        <th>Uyruk</th>
        <th>Eğitim Durumu</th>
        <th>Departman</th>
        <th>Çalışma Tipi</th>
        <th>Çalışma Durumu</th>
        <th>Yetki</th>
        <th>Grup</th>
        <th>Son Güncelleme</th>
        <th>İşlemler</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr>
        <td data-label="Sicil No">{{ user.user_id }}</td>
        <td data-label="Ad Soyad">{{ user.name if user.name else '-' }}</td>
        <td data-label="Kart No">{{ user.card if user.card else '-' }}</td>
        <td data-label="Cinsiyet">{{ user.gender if user.gender else '-' }}</td>
        <td data-label="Meslek">
          {{ user.occupation if user.occupation else '-' }}
        </td>
        <td data-label="İş Tanımı">
          {{ user.job_title if user.job_title else '-' }}
        </td>
        <td data-label="Uyruk">
          {{ user.nationality if user.nationality else '-' }}
        </td>
        <td data-label="Eğitim Durumu">
          {{ user.education_level if user.education_level else '-' }}
        </td>
        <td data-label="Departman">
          {{ user.department.department_name if user.department else '-' }}
        </td>
        <td data-label="Çalışma Tipi">
          {{ user.work_type if user.work_type else '-' }}
        </td>
        <td data-label="Çalışma Durumu">
          {{ user.employment_status if user.employment_status else '-' }}
        </td>
        <td data-label="Yetki">
          {% if user.device_role == 0 %}
          <span class="badge bg-secondary">Kullanıcı</span>
          {% elif user.device_role == 14 %}
          <span class="badge bg-warning">Yönetici</span>
          {% elif user.device_role == 3 %}
          <span class="badge bg-success">Kayıt</span>
          {% else %}
          <span class="badge bg-light text-dark"
            >Yetki {{ user.device_role }}</span
          >
          {% endif %}
        </td>
        <td data-label="Grup">{{ user.group_id if user.group_id else '-' }}</td>
        <td data-label="Son Güncelleme">
          {{ user.last_update if user.last_update else '-' }}
        </td>
        <td data-label="İşlemler">
          <div class="btn-group">
            {% if user.user_id %}
            <a
              href="{{ url_for('edit_user', user_id=user.user_id) }}"
              class="btn btn-sm btn-outline-primary"
            >
              <i class="fas fa-edit"></i> Düzenle
            </a>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary disabled">
              <i class="fas fa-edit"></i> Düzenle
            </span>
            {% endif %} {% if user.user_id %}
            <button
              type="button"
              class="btn btn-sm btn-outline-danger"
              onclick="confirmDeleteUser('{{ user.user_id }}', '{{ user.name }}')"
            >
              <i class="fas fa-trash"></i> Sil
            </button>
            {% else %}
            <span class="btn btn-sm btn-outline-secondary disabled">
              <i class="fas fa-trash"></i> Sil
            </span>
            {% endif %}
          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="15" class="text-center">Henüz kullanıcı bulunmuyor</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if total_pages is defined and total_pages > 1 %}
<nav aria-label="Sayfalama">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page == 1 %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('users', page=page-1) }}"
        aria-label="Önceki"
      >
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('users', page=p) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('users', page=page+1) }}"
        aria-label="Sonraki"
      >
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
{% endif %}

<div class="d-flex justify-content-center mt-3">
  <span class="text-muted">Toplam Kullanıcı: {{ users|length }}</span>
</div>

{% if search is defined and search %}
<div class="text-center mt-3">
  <a href="{{ url_for('users') }}" class="btn btn-outline-secondary">
    <i class="fas fa-arrow-left"></i> Tüm Kullanıcıları Göster
  </a>
</div>
{% endif %} {% endblock %} {% block additional_scripts %}
<script>
  // SweetAlert ile kullanıcı silme onayı
  function confirmDeleteUser(userId, userName) {
    Swal.fire({
      title: "Kullanıcı Silme Onayı",
      html: `<strong>${userName}</strong> isimli kullanıcıyı silmek istediğinize emin misiniz?<br><br><span class="text-danger">Bu işlem geri alınamaz ve kullanıcıya ait tüm kayıtlar da silinecektir!</span>`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#6c757d",
      confirmButtonText: "Evet, Sil",
      cancelButtonText: "İptal",
      customClass: {
        popup: "swal-custom-popup",
        confirmButton: "swal-custom-button",
        cancelButton: "swal-custom-cancel-button",
      },
    }).then((result) => {
      if (result.isConfirmed) {
        // Silme işlemi başladığında loading göster
        Swal.fire({
          title: "Siliniyor...",
          text: "Lütfen bekleyin.",
          icon: "info",
          allowOutsideClick: false,
          showConfirmButton: false,
          customClass: {
            popup: "swal-custom-popup",
          },
        });

        // Form oluştur ve gönder
        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/users/delete/${userId}`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>
<script src="{{ url_for('static', filename='js/users.js') }}"></script>
{% endblock %}
