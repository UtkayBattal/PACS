{% extends 'layout.html' %} {% block content %}
<div
  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
>
  <h1 class="h2">Giriş/Çıkış Kayıtları</h1>
  <div class="btn-toolbar mb-2 mb-md-0">
    <button
      type="button"
      class="btn btn-sm btn-danger"
      onclick="confirmDeleteAllRecords()"
    >
      <i class="fas fa-trash"></i> Toplu Kayıt Silme
    </button>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">Kayıt Arama</h5>
  </div>
  <div class="card-body">
    <form action="{{ url_for('search_records') }}" method="GET" class="row g-3">
      <div class="col-md-4">
        <label for="q" class="form-label">Arama Terimi</label>
        <input
          type="text"
          name="q"
          id="q"
          class="form-control"
          placeholder="İsim, ID veya kart no"
          value="{{ search_term if search_term else '' }}"
        />
        <div class="form-text">
          İsim, ID veya kart numarası ile arama yapabilirsiniz.
        </div>
      </div>
      <div class="col-md-3">
        <label for="date_from" class="form-label">Başlangıç Tarihi</label>
        <input
          type="date"
          name="date_from"
          id="date_from"
          class="form-control"
          value="{{ date_from if date_from else '' }}"
        />
      </div>
      <div class="col-md-3">
        <label for="date_to" class="form-label">Bitiş Tarihi</label>
        <input
          type="date"
          name="date_to"
          id="date_to"
          class="form-control"
          value="{{ date_to if date_to else '' }}"
        />
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">
          <i class="fas fa-search"></i> Ara
        </button>
      </div>
    </form>
  </div>
</div>

{% if is_search %}
<div class="alert alert-info">
  <h5 class="alert-heading"><i class="fas fa-filter"></i> Arama Sonuçları</h5>
  <p>
    {% if search_term %}Arama Terimi: <strong>{{ search_term }}</strong>{% endif
    %} {% if date_from %} &middot; Başlangıç: <strong>{{ date_from }}</strong>{%
    endif %} {% if date_to %} &middot; Bitiş: <strong>{{ date_to }}</strong>{%
    endif %}
  </p>
  <hr />
  <p class="mb-0">
    <a href="{{ url_for('records') }}" class="btn btn-sm btn-outline-secondary">
      <i class="fas fa-times"></i> Filtreleri Temizle
    </a>
  </p>
</div>
{% endif %}

<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Kullanıcı</th>
        <th>Kart No</th>
        <th>Tarih/Saat</th>
        <th>Terminal</th>
        <th>İşlem</th>
        <th>Eylemler</th>
      </tr>
    </thead>
    <tbody>
      {% for record, user, device in records %}
      <tr>
        <td>{{ record.id }}</td>
        <td>
          {% if user.name %} {{ user.name }} {% else %}
          <span class="text-muted">NN-{{ record.user_id }}</span>
          {% endif %}
          <small class="text-muted d-block">ID: {{ record.user_id }}</small>
        </td>
        <td>{{ user.card_no if user.card_no else '-' }}</td>
        <td>{{ record.timestamp.strftime('%d.%m.%Y %H:%M') }}</td>
        <td>
          {% if device and device.name %}
          <span class="badge bg-secondary">{{ device.name }}</span>
          {% else %}
          <span class="badge bg-secondary">Belirsiz</span>
          {% endif %}
        </td>
        <td>
          {% if record.status == 'Geç Giriş' %}
          <span class="badge bg-warning text-dark"
            >Giriş <i class="fas fa-exclamation-circle"></i
          ></span>
          <span class="badge bg-danger">Geç Giriş</span>
          {% elif record.status == 'Eksik Hareket' %}
          <span class="badge bg-warning text-dark"
            >Çıkış <i class="fas fa-exclamation-circle"></i
          ></span>
          <span class="badge bg-danger">Eksik Hareket</span>
          {% elif record.punch == 0 %}
          <span class="badge bg-success">Giriş</span>
          {% elif record.punch == 1 %}
          <span class="badge bg-danger">Çıkış</span>
          {% elif record.status == 'Manuel Giriş' or record.status == '5' %}
          <span class="badge bg-warning">Manuel Giriş</span>
          {% elif record.status == 'Manuel Çıkış' or record.status == '6' %}
          <span class="badge bg-warning">Manuel Çıkış</span>
          {% else %}
          <span class="badge bg-secondary"
            >{{ record.status if record.status else record.punch }}</span
          >
          {% endif %}
        </td>
        <td>
          <button
            type="button"
            class="btn btn-sm btn-outline-danger"
            onclick="confirmDeleteRecord('{{ record.id }}', '{% if user.name %}{{ user.name }}{% else %}NN-{{ record.user_id }}{% endif %}', '{{ record.timestamp.strftime('%d.%m.%Y %H:%M') }}', '{% if record.status == 'Geç Giriş' %}Giriş (Geç Giriş){% elif record.status == 'Eksik Hareket' %}Çıkış (Eksik Hareket){% elif record.punch == 0 %}Giriş{% elif record.punch == 1 %}Çıkış{% else %}{{ record.status }}{% endif %}')"
          >
            <i class="fas fa-trash"></i> Sil
          </button>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7" class="text-center">Kayıt bulunamadı</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Sayfalama">
  <ul class="pagination justify-content-center">
    {% if page > 1 %}
    <li class="page-item">
      {% if is_search %} {% if search_term %}
      <a
        class="page-link"
        href="{{ url_for('search_records', q=search_term, date_from=date_from, date_to=date_to, page=page-1) }}"
        >Önceki</a
      >
      {% else %}
      <a
        class="page-link"
        href="{{ url_for('search_records', date_from=date_from, date_to=date_to, page=page-1) }}"
        >Önceki</a
      >
      {% endif %} {% else %}
      <a
        class="page-link"
        href="{{ url_for('records', page=page-1, search=search) }}"
        >Önceki</a
      >
      {% endif %}
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">Önceki</span>
    </li>
    {% endif %} {% for i in range(1, total_pages + 1) %} {% if i == page %}
    <li class="page-item active"><span class="page-link">{{ i }}</span></li>
    {% elif i > page - 3 and i < page + 3 %}
    <li class="page-item">
      {% if is_search %} {% if search_term %}
      <a
        class="page-link"
        href="{{ url_for('search_records', q=search_term, date_from=date_from, date_to=date_to, page=i) }}"
        >{{ i }}</a
      >
      {% else %}
      <a
        class="page-link"
        href="{{ url_for('search_records', date_from=date_from, date_to=date_to, page=i) }}"
        >{{ i }}</a
      >
      {% endif %} {% else %}
      <a
        class="page-link"
        href="{{ url_for('records', page=i, search=search) }}"
        >{{ i }}</a
      >
      {% endif %}
    </li>
    {% endif %} {% endfor %} {% if page < total_pages %}
    <li class="page-item">
      {% if is_search %} {% if search_term %}
      <a
        class="page-link"
        href="{{ url_for('search_records', q=search_term, date_from=date_from, date_to=date_to, page=page+1) }}"
        >Sonraki</a
      >
      {% else %}
      <a
        class="page-link"
        href="{{ url_for('search_records', date_from=date_from, date_to=date_to, page=page+1) }}"
        >Sonraki</a
      >
      {% endif %} {% else %}
      <a
        class="page-link"
        href="{{ url_for('records', page=page+1, search=search) }}"
        >Sonraki</a
      >
      {% endif %}
    </li>
    {% else %}
    <li class="page-item disabled">
      <span class="page-link">Sonraki</span>
    </li>
    {% endif %}
  </ul>
</nav>

<div class="text-center text-muted">
  <small
    >Toplam {{ total_records|default(0) }} kayıt ({{ page|default(1) }} / {{
    total_pages|default(1) }} sayfa)</small
  >
</div>
{% endblock %} {% block additional_scripts %}
<script>
  // SweetAlert ile tek kayıt silme onayı
  function confirmDeleteRecord(recordId, userName, dateTime, operation) {
    Swal.fire({
      title: "Kayıt Silme Onayı",
      html: `
      <div class="text-start">
        <p><strong>${recordId}</strong> numaralı kaydı silmek istediğinize emin misiniz?</p>
        <hr>
        <p>
          <strong>Kullanıcı:</strong> ${userName}<br>
          <strong>Tarih/Saat:</strong> ${dateTime}<br>
          <strong>İşlem:</strong> ${operation}
        </p>
        <div class="alert alert-danger mt-3">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Bu işlem geri alınamaz!</strong>
        </div>
      </div>
    `,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#6c757d",
      confirmButtonText: "Evet, Sil",
      cancelButtonText: "İptal",
      customClass: {
        popup: "swal-custom-popup",
        confirmButton: "swal-custom-button",
        cancelButton: "swal-custom-cancel-button",
      },
    }).then((result) => {
      if (result.isConfirmed) {
        // Silme işlemi başladığında loading göster
        Swal.fire({
          title: "Siliniyor...",
          text: "Kayıt siliniyor, lütfen bekleyin.",
          icon: "info",
          allowOutsideClick: false,
          showConfirmButton: false,
          customClass: {
            popup: "swal-custom-popup",
          },
        });

        // Form oluştur ve gönder
        const form = document.createElement("form");
        form.method = "POST";
        form.action = `/records/delete/${recordId}`;
        document.body.appendChild(form);
        form.submit();
      }
    });
  }

  // SweetAlert ile toplu kayıt silme onayı
  function confirmDeleteAllRecords() {
    Swal.fire({
      title: "Toplu Kayıt Silme",
      html: `
      <div class="text-start">
        <div class="alert alert-danger mb-3">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Dikkat!</strong> Bu işlem geri alınamaz!
        </div>
        <p>Belirttiğiniz tarih aralığındaki tüm kayıtları silmek üzeresiniz.</p>
        
        <div class="mb-3">
          <label for="swal_date_from" class="form-label">Başlangıç Tarihi</label>
          <input type="date" id="swal_date_from" class="form-control">
          <div class="form-text">Boş bırakırsanız en eski kayıttan itibaren silinir.</div>
        </div>
        
        <div class="mb-3">
          <label for="swal_date_to" class="form-label">Bitiş Tarihi</label>
          <input type="date" id="swal_date_to" class="form-control">
          <div class="form-text">Boş bırakırsanız en son kayda kadar silinir.</div>
        </div>
        
        <div class="alert alert-warning">
          <strong>Her iki tarih de boş bırakılırsa tüm kayıtlar silinecektir!</strong>
        </div>
      </div>
    `,
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#6c757d",
      confirmButtonText: "Kayıtları Sil",
      cancelButtonText: "İptal",
      customClass: {
        popup: "swal-custom-popup swal-wide",
        confirmButton: "swal-custom-button",
        cancelButton: "swal-custom-cancel-button",
      },
      preConfirm: () => {
        const dateFrom = document.getElementById("swal_date_from").value;
        const dateTo = document.getElementById("swal_date_to").value;
        return { dateFrom, dateTo };
      },
    }).then((result) => {
      if (result.isConfirmed) {
        // Silme işlemi başladığında loading göster
        Swal.fire({
          title: "Siliniyor...",
          text: "Kayıtlar siliniyor, lütfen bekleyin.",
          icon: "info",
          allowOutsideClick: false,
          showConfirmButton: false,
          customClass: {
            popup: "swal-custom-popup",
          },
        });

        // Form oluştur ve gönder
        const form = document.createElement("form");
        form.method = "POST";
        form.action = "/records/delete-all";

        // Tarih inputlarını ekle
        if (result.value.dateFrom) {
          const dateFromInput = document.createElement("input");
          dateFromInput.type = "hidden";
          dateFromInput.name = "date_from";
          dateFromInput.value = result.value.dateFrom;
          form.appendChild(dateFromInput);
        }

        if (result.value.dateTo) {
          const dateToInput = document.createElement("input");
          dateToInput.type = "hidden";
          dateToInput.name = "date_to";
          dateToInput.value = result.value.dateTo;
          form.appendChild(dateToInput);
        }

        document.body.appendChild(form);
        form.submit();
      }
    });
  }
</script>

<style>
  .swal-wide {
    width: 600px !important;
  }
</style>
{% endblock %}
