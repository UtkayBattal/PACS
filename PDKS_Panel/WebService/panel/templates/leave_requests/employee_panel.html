{% extends "layout.html" %} {% block title %}İzin Taleplerim{% endblock %} {%
block content %}
<div class="container-fluid px-4">
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">
      <i class="fas fa-calendar-alt me-2"></i>İzin Taleplerim
    </h1>
    <div>
      <small class="text-muted">Kullanıcı: {{ current_user.name }} (Role ID: {{ current_user.role_id }})</small>
      <button
        type="button"
        class="btn btn-primary"
        onclick="window.location.href='{{ url_for('leave_requests.create_request') }}'"
      >
        <i class="fas fa-plus me-1"></i> Yeni İzin Talebi
      </button>
    </div>
  </div>

  <!-- İstatistik Kartları -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-warning text-uppercase mb-1"
              >
                Bekleyen
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ requests|selectattr('status', 'equalto',
                'bekleniyor')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-clock fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-success text-uppercase mb-1"
              >
                Onaylanan
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ requests|selectattr('status', 'equalto',
                'onaylandı')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-check-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-danger text-uppercase mb-1"
              >
                Reddedilen
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ requests|selectattr('status', 'equalto',
                'reddedildi')|list|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-times-circle fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-info shadow h-100 py-2">
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div
                class="text-xs font-weight-bold text-info text-uppercase mb-1"
              >
                Toplam
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                {{ requests|length }}
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-list fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- İzin Talepleri Tablosu -->
  <div class="card shadow mb-4">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">
        <i class="fas fa-table me-1"></i>İzin Talep Geçmişi
      </h6>
    </div>
    <div class="card-body">
      {% if requests %}
      <div class="table-responsive">
        <table
          class="table table-bordered"
          id="dataTable"
          width="100%"
          cellspacing="0"
        >
          <thead>
            <tr>
              <th>Talep Tarihi</th>
              <th>İzin Türü</th>
              <th>Başlangıç</th>
              <th>Bitiş</th>
              <th>Gün Sayısı</th>
              <th>Sebep</th>
              <th>Durum</th>
              <th>İşlemler</th>
            </tr>
          </thead>
          <tbody>
            {% for req in requests %}
            <tr>
              <td>{{ req.request_date.strftime('%d.%m.%Y %H:%M') }}</td>
              <td>{{ req.leave_type }}</td>
              <td>{{ req.start_date.strftime('%d.%m.%Y') }}</td>
              <td>{{ req.end_date.strftime('%d.%m.%Y') }}</td>
              <td>{{ req.days_count or req.calculate_days() }} gün</td>
              <td>
                <span
                  class="text-truncate"
                  style="max-width: 200px"
                  title="{{ req.reason }}"
                >
                  {{ req.reason[:50] }}{% if req.reason|length > 50 %}...{%
                  endif %}
                </span>
              </td>
              <td>
                {% if req.status == 'bekleniyor' %}
                <span class="badge bg-warning text-dark">
                  <i class="fas fa-clock me-1"></i>Bekleniyor
                </span>
                {% elif req.status == 'onaylandı' %}
                <span class="badge bg-success">
                  <i class="fas fa-check me-1"></i>Onaylandı
                </span>
                {% elif req.status == 'reddedildi' %}
                <span class="badge bg-danger">
                  <i class="fas fa-times me-1"></i>Reddedildi
                </span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group" role="group">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-info"
                    onclick="showDetails({{ req.id }})"
                    title="Detay"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                  {% if req.status == 'bekleniyor' %}
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    onclick="cancelRequest({{ req.id }})"
                    title="İptal Et"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-5">
        <i class="fas fa-calendar-times fa-3x text-gray-300 mb-3"></i>
        <h5 class="text-gray-500">Henüz hiç izin talebiniz bulunmamaktadır.</h5>
        <p class="text-gray-400">
          Yeni bir izin talebi oluşturmak için yukarıdaki butonu
          kullanabilirsiniz.
        </p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Detay Modal -->
<div
  class="modal fade"
  id="detailModal"
  tabindex="-1"
  aria-labelledby="detailModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailModalLabel">
          <i class="fas fa-info-circle me-2"></i>İzin Talebi Detayı
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body" id="detailContent">
        <!-- Ajax ile doldurulacak -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Kapat
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block additional_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('İzin Taleplerim sayfası yüklendi');
  });

  function showDetails(requestId) {
    // Detay modalını göster
    const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
    detailModal.show();

    // Fetch ile detayları getir
    fetch(`/leave-requests/employee/details/${requestId}`)
      .then(response => {
        if (response.ok) {
          return response.text();
        }
        throw new Error('Detaylar yüklenemedi');
      })
      .then(data => {
        document.getElementById('detailContent').innerHTML = data;
      })
      .catch(error => {
        document.getElementById('detailContent').innerHTML = 
          '<p class="text-danger">Detaylar yüklenirken hata oluştu.</p>';
      });
  }

  function cancelRequest(requestId) {
    // SweetAlert2 ile şık onay dialogu
    Swal.fire({
      title: 'İzin Talebini İptal Et',
      html: `
        <div class="text-center">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <p class="mb-2">Bu izin talebini iptal etmek istediğinizden emin misiniz?</p>
          <small class="text-muted">Bu işlem geri alınamaz.</small>
        </div>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: '<i class="fas fa-trash me-1"></i> Evet, İptal Et',
      cancelButtonText: '<i class="fas fa-times me-1"></i> Vazgeç',
      reverseButtons: true,
      customClass: {
        popup: 'swal-custom-popup',
        confirmButton: 'swal-custom-button',
        cancelButton: 'swal-custom-cancel-button'
      }
    }).then((result) => {
      if (result.isConfirmed) {
        // Yükleniyor mesajı
        Swal.fire({
          title: 'İşleniyor...',
          html: '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><br><small class="text-muted mt-2">İzin talebi iptal ediliyor...</small></div>',
          allowOutsideClick: false,
          showConfirmButton: false,
          customClass: {
            popup: 'swal-custom-popup'
          }
        });

        // İptal isteği gönder
        fetch(`/leave-requests/employee/cancel/${requestId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Başarı mesajı
            Swal.fire({
              title: 'Başarılı!',
              html: `
                <div class="text-center">
                  <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                  <p class="mb-2">${data.message}</p>
                  <small class="text-muted">Sayfa yenileniyor...</small>
                </div>
              `,
              icon: 'success',
              timer: 2000,
              timerProgressBar: true,
              showConfirmButton: false,
              customClass: {
                popup: 'swal-custom-popup'
              }
            }).then(() => {
              window.location.reload();
            });
          } else {
            // Hata mesajı
            Swal.fire({
              title: 'Hata!',
              html: `
                <div class="text-center">
                  <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                  <p class="mb-2">${data.message}</p>
                  <small class="text-muted">Lütfen tekrar deneyiniz.</small>
                </div>
              `,
              icon: 'error',
              confirmButtonText: '<i class="fas fa-redo me-1"></i> Tamam',
              confirmButtonColor: '#dc3545',
              customClass: {
                popup: 'swal-custom-popup',
                confirmButton: 'swal-custom-button'
              }
            });
          }
        })
        .catch(error => {
          // Ağ hatası
          Swal.fire({
            title: 'Bağlantı Hatası!',
            html: `
              <div class="text-center">
                <i class="fas fa-wifi fa-3x text-danger mb-3"></i>
                <p class="mb-2">İşlem sırasında bir hata oluştu.</p>
                <small class="text-muted">İnternet bağlantınızı kontrol ediniz.</small>
              </div>
            `,
            icon: 'error',
            confirmButtonText: '<i class="fas fa-redo me-1"></i> Tekrar Dene',
            confirmButtonColor: '#dc3545',
            customClass: {
              popup: 'swal-custom-popup',
              confirmButton: 'swal-custom-button'
            }
          });
        });
      }
    });
  }
</script>
{% endblock %}
